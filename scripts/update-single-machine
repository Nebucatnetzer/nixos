# -*- mode: python -*-
#!/usr/bin/env -S nix shell .#pkgs.python3 --command python
# Be awayre this code was mainly generated by an LLM!

import argparse
import os
import subprocess


def main() -> None:
    rsa_key: str = os.path.expanduser("~/.nixos/secrets/ssh_keys/ansible/ansible.key")
    os.environ["NIX_SSHOPTS"] = f"-i {rsa_key}"

    parser: argparse.ArgumentParser = argparse.ArgumentParser(
        description="Remote NixOS deployment tool",
    )
    parser.add_argument("host", help="Target hostname")
    parser.add_argument(
        "-r",
        "--reboot",
        action="store_true",
        help="Reboot the host after boot deployment",
    )
    args: argparse.Namespace = parser.parse_args()

    host: str = args.host
    fqdn: str = f"{host}.2li.local"

    if args.reboot:
        print(f"{fqdn} with reboot")
        subprocess.run(
            [
                "nixos-rebuild-ng",
                "boot",
                "-j",
                "auto",
                "--sudo",
                "--target-host",
                fqdn,
                "--flake",
                f".#{host}",
            ],
            check=True,
        )
        subprocess.run(["ssh", "-i", rsa_key, fqdn, "sudo reboot"], check=True)
    else:
        print(f"{fqdn}")
        subprocess.run(
            [
                "nixos-rebuild-ng",
                "switch",
                "-j",
                "auto",
                "--sudo",
                "--target-host",
                fqdn,
                "--flake",
                f".#{host}",
            ],
            check=True,
        )

    print()
    print()


if __name__ == "__main__":
    main()
