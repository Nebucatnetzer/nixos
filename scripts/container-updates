#!/usr/bin/env -S nix shell .#pkgs.ripgrep .#pkgs.skopeo .#pkgs.python3 --command python
# -*- mode: python -*-
# Be awayre this code was mainly generated by an LLM!
"""Get the latest three tags for the provided images."""

import re
import subprocess


def run_command(command: list[str]) -> str:
    result = subprocess.run(
        command,
        capture_output=True,
        check=True,
        text=True,
    )
    return result.stdout.strip()


def get_digest(image: str) -> str:
    inspect_output = run_command(["skopeo", "inspect", f"docker://{image}:latest"])
    for line in inspect_output.splitlines():
        if '"Digest":' in line:
            return line.split(":", 1)[1].strip().strip('",')
    error_message = f"Digest not found for image: {image}"
    raise ValueError(error_message)


def get_tags(image: str) -> list[str]:
    inspect_output = run_command(["skopeo", "inspect", f"docker://{image}"])
    repo_tags = re.findall(r'"RepoTags":\s*\[(.*?)\]', inspect_output, re.DOTALL)
    if not repo_tags:
        return []

    tag_block = repo_tags[0]
    tags = re.findall(r'"(.*?)"', tag_block)

    filtered_tags: list[str] = []
    for tag in tags:
        if "2021" in tag or "61a5a1" in tag:
            continue
        tag_normalized = (
            tag.lower().replace("version-v", "version-").replace("version-", "")
        )
        match = re.match(r"^(\d+)\.(\d+)\.(\d+)$", tag_normalized)
        if match:
            filtered_tags.append(tag_normalized)

    # Sort by semantic versioning descending
    def version_key(s: str) -> tuple[int, ...]:
        return tuple(map(int, s.split(".")))

    filtered_tags.sort(key=version_key, reverse=True)
    return filtered_tags[:3]


def find_image_references(image: str, search_path: str = "./modules") -> str:
    """Find image in code."""
    return run_command(["rg", image, search_path])


def main() -> None:
    images: list[str] = [
        "docker.io/fireflyiii/data-importer",
        "docker.io/gitea/gitea",
        "docker.io/nginx",
        "ghcr.io/actualbudget/actual-server",
        "ghcr.io/nebucatnetzer/meta-search/zweili-search-app",
        "ghcr.io/nebucatnetzer/nextcloud-smb/nextcloud-smb",
        "lscr.io/linuxserver/plex",
    ]

    for image in images:
        print("Get " + image)
        try:
            digest = get_digest(image)
            tags = get_tags(image)
            references = find_image_references(image)

            print(f"Image: {image}")
            print(f"Digest: {digest}")
            print("Tags:")
            for tag in tags:
                print(tag)
            print(references)
            print("\n")

        except subprocess.CalledProcessError as e:
            print(f"Error inspecting image {image}: {e.stderr}")


if __name__ == "__main__":
    main()
