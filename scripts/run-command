#!/usr/bin/env -S nix shell .#pkgs.python3 --command python
# -*- mode: python -*-
# Be awayre this code was mainly generated by an LLM!

import os
import subprocess
from pathlib import Path


def get_hostnames() -> list[str]:
    cmd = [
        "nix",
        "eval",
        ".#nixosConfigurations",
        "--apply",
        'pkgs: builtins.concatStringsSep " " (builtins.attrNames pkgs)',
    ]
    result = subprocess.run(cmd, capture_output=True, text=True, check=True)
    hosts_str = result.stdout.strip().strip('"')
    return hosts_str.split()


def main(command: str) -> None:
    os.chdir("/home/andreas/.nixos")

    hosts: list[str] = get_hostnames()
    skip: list[str] = [
        "desktop-vm",
        "gwyn",
        "loki-test",
        "mobile",
        "staubfinger",
        "test-raspi",
    ]

    rsa_key: str = Path("~/.nixos/secrets/ssh_keys/ansible/ansible.key").expanduser()

    for host in hosts:
        if host in skip:
            continue
        fqdn: str = f"{host}.2li.local"
        print(fqdn)
        ssh_cmd: list[str] = ["ssh", "-i", rsa_key, fqdn, command]
        subprocess.run(ssh_cmd, check=False)
        print()
        print()


if __name__ == "__main__":
    import sys

    minimum_number_of_args = 2
    if len(sys.argv) < minimum_number_of_args:
        print("Usage: run-command '<command>'")
        sys.exit(1)
    user_command: str = sys.argv[1]
    main(user_command)
